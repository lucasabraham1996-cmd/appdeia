<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 Desafío de IA y Ciencia de Datos 🚀</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de Fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Aplicar la fuente base y estilos de fondo */
        body {
            font-family: 'Inter', sans-serif;
            /* Degradado de fondo dinámico */
            background: linear-gradient(135deg, #1A2980 0%, #26D0CE 100%); /* Azul oscuro a cian */
            background-size: 400% 400%; /* Permite la animación del degradado */
            animation: backgroundAnimation 15s ease infinite alternate; /* Animación */
            
            /* --- MODIFICACIONES PARA SCROLL EN MÓVIL --- */
            background-attachment: fixed; /* 1. Fija el fondo para que no se desplace con el contenido */
            min-height: 100vh;
            display: flex;
            align-items: flex-start; /* 2. Alinea la tarjeta al inicio (arriba) en lugar de centrarla */
            justify-content: center;
            padding: 2rem 1rem; /* 3. Añade padding vertical para que no pegue al borde */
            /* overflow: hidden; <-- 4. ELIMINADO para permitir scroll si el contenido es muy alto */
        }

        /* Keyframes para la animación del fondo */
        @keyframes backgroundAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Estilo para el contenedor principal - EFECTO GLASEADO */
        #game-container {
            background-color: rgba(255, 255, 255, 0.2); /* Fondo blanco translúcido */
            backdrop-filter: blur(10px); /* Efecto de glaseado */
            -webkit-backdrop-filter: blur(10px); /* Para compatibilidad con Safari */
            border-radius: 1.5rem; /* Bordes más redondeados */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
            padding: 2.5rem;
            transition: all 0.3s ease-in-out;
            max-width: 48rem; /* Ancho máximo aumentado */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Borde sutil para el glaseado */
        }
        
        /* Animación de entrada */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos de botones de elección */
        .choice-button {
            transition: all 0.2s ease-in-out;
            /* Texto oscuro para mejor contraste sobre fondo glaseado */
            color: #1A2980; 
        }
        .choice-button:hover:not(:disabled) { /* No aplicar hover si está deshabilitado */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* --- ESTILOS PARA FEEDBACK ANIMADO --- */
        #feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; /* Permite hacer clic a través de él */
            z-index: 1000;
            overflow: hidden;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 20px;
            opacity: 1;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(110vh) rotate(720deg);
                opacity: 0;
            }
        }

        .feedback-cross {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 20rem; /* Cruz gigante */
            line-height: 1;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            animation: cross-fade 1.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
        }

        @keyframes cross-fade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* --- ESTILOS DE INICIO / OCULTO --- */
        #game-content, #feedback-area, #controls, #timer-container, #fullscreen-button {
            display: none; /* Oculto al inicio */
        }
        #intro-screen {
            display: block; /* Visible al inicio */
        }
    </style>
</head>
<body>
    <!-- Capa para animaciones de feedback (confeti, etc.) -->
    <div id="feedback-overlay"></div>

    <!-- Contenedor principal del juego -->
    <div class="w-full max-w-3xl">
        <div id="game-container" class="transition-all duration-300">
            
            <!-- Encabezado con título y cronómetro -->
            <header class="text-center mb-8 relative">
                
                <!-- Botón de Pantalla Completa -->
                <div class="flex justify-center mb-4">
                    <button id="fullscreen-button" title="Jugar en Pantalla Completa" class="p-2 text-white hover:text-blue-200 transition-colors bg-white/20 backdrop-blur-sm rounded-lg shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4-4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 4l-5-5"></path></svg>
                    </button>
                </div>

                <h1 class="text-4xl sm:text-5xl font-extrabold text-white leading-tight">
                    🌟 Desafío <span class="text-blue-300">IA & Datos</span> 🚀
                </h1>
                <p class="text-xl text-blue-100 mt-2">
                    Pon a prueba tu intuición y conocimiento
                </p>

                <!-- Contenedor del Cronómetro -->
                <div class="flex justify-center mt-4">
                    <div id="timer-container" class="p-2 text-white font-semibold flex items-center gap-2 bg-white/20 backdrop-blur-sm rounded-lg shadow-lg">
                        ⏱️ <span id="timer">03:00</span>
                    </div>
                </div>
            </header>

            <!-- Contenido principal del juego (preguntas, opciones) -->
            <main id="game-content" class="mb-8 min-h-[250px] sm:min-h-[200px] flex flex-col justify-center">
                <!-- El contenido de la pregunta se renderiza aquí -->
            </main>

            <!-- Pantalla de Introducción -->
            <div id="intro-screen" class="text-center">
                <h2 class="text-3xl font-bold text-white mb-4">¿Listo para el desafío?</h2>
                <p class="text-xl text-blue-100 mb-8">Tienes <span class="font-bold text-blue-300">3 minutos</span> para responder 13 preguntas.</p>
                <button id="start-button" class="w-full sm:w-auto bg-green-500 text-white font-bold py-4 px-10 rounded-xl hover:bg-green-600 transition-all text-xl shadow-lg transform hover:scale-105">
                    ¡Comenzar a Jugar!
                </button>
            </div>

            <!-- Área de Feedback (Correcto/Incorrecto) -->
            <!-- MODIFICACIÓN: Este div ya no se usará para la explicación, pero lo dejamos por si acaso -->
            <div id="feedback-area" class="mb-8">
                <!-- El feedback se renderiza aquí -->
            </div>

            <!-- Controles (Reiniciar, Siguiente) -->
            <footer id="controls" class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <button id="restart-button" class="w-full sm:w-auto bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-800 transition-all text-lg">
                    🔄 Reiniciar Juego
                </button>
                
                <!-- Contenedor para el botón de acción (Siguiente/Comprobar) -->
                <div id="action-button-container" class="w-full sm:w-auto"></div>
            </footer>
            
        </div>
    </div>

    <script>
        // --- FUNCIÓN PARA BARAJAR ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- BASE DE DATOS DEL JUEGO ---
        const gameData = [
            // --- Nivel 1: Predice el Futuro (AHORA TIPO 'NETWORK' CON OPCIONES) ---
            {
                type: 'network', 
                question: 'Un gamer jugó 🎮 <strong>10, 20, y 40</strong> minutos en los últimos 3 días. ¿Cuántos minutos crees que jugará mañana?',
                options: ['80', '60', '70', '50'], 
                answer: '70',
                explanation: '¡Es una trampa! La respuesta obvia es 80 (duplicando). Pero un analista de datos también vería el patrón +10, +20, y luego <strong>+30</strong>. ¡Ambas son predicciones válidas, pero esta es más sutil! (Si elegiste 80, también es un patrón lógico).'
            },
            {
                type: 'network', 
                question: 'Una app tuvo 🧘‍♀️ <strong>500, 600, 800, y 1100</strong> descargas. ¿Cuántas tendrá en la siguiente medición?',
                options: ['1400', '1500', '1600', '1200'], 
                answer: '1500',
                explanation: '¡Bien visto! El patrón no era constante. El aumento crecía: primero +100 (500 a 600), luego +200 (600 a 800), luego +300 (800 a 1100). El siguiente paso lógico es sumar <strong>+400</strong>, lo que da 1500.'
            },
            {
                type: 'network', 
                question: 'Un blog tuvo 📈 <strong>1000, 950, 900, y 850</strong> visitas. Pero justo ayer, un artículo se hizo viral y saltó a 5000 visitas. Si quisieras predecir un día "normal" (sin el evento viral), ¿cuántas visitas esperarías?',
                options: ['5000', '800', '750', '4000'], 
                answer: '800',
                explanation: '¡Perfecto! Esto se llama <strong>limpieza de datos</strong>. El analista debe ignorar el "outlier" (valor atípico) de 5000 para encontrar la tendencia real, que era <strong>-50</strong> por día. La predicción normal era 800.'
            },

            // --- Nivel 2: IA o Humano (Ahora 5 preguntas) ---
            {
                type: 'ai-human',
                question: 'Este mensaje de texto, con sus errores y su estilo casual... ¿es de una IA o de un humano?',
                content: {
                    type: 'text',
                    text: 'Fui a la tienda pero se me olvidó la lista, obvio. Traje pan, leche... y creo que lo más importante no. Jajaja. Mañana será otro día.'
                },
                answer: 'humano',
                explanation: '¡Correcto! Es 100% humano. El "obvio", el "jajaja" y la estructura de pensamiento (olvidar la lista) son patrones muy típicos de la comunicación humana informal, algo que a las IAs les cuesta replicar con naturalidad.'
            },
            {
                type: 'ai-human',
                question: 'Este análisis financiero, tan formal y técnico... ¿fue escrito por una IA o por un analista humano experto?',
                content: {
                    type: 'text',
                    text: 'El análisis de sentimiento del mercado indica una volatilidad alcista, correlacionada con los patrones de inversión en derivados de tecnología emergente. Se recomienda una estrategia de diversificación de portafolio para mitigar el riesgo.'
                },
                answer: 'ia',
                explanation: '¡Es de una IA! Este es un truco. Aunque un humano PODRÍA escribir esto, las IAs son *extremadamente* buenas generando texto técnico, formal y lleno de jerga. A menudo lo hacen de forma más densa y rápida que un humano.'
            },
            {
                type: 'ai-human',
                question: 'Esta famosa imagen del Papa con una campera de plumas blanca, ¿es real o fue hecha con IA?',
                content: {
                    type: 'image',
                    src: 'https://piktochart.com/wp-content/uploads/2023/11/pope-wearing-balenciaga-jacket-viral-ai-images.jpeg',
                    alt: 'El Papa Francisco usando una llamativa campera blanca de plumas.'
                },
                answer: 'ia',
                explanation: '¡Correcto! Es de IA. Esta fue una de las imágenes generadas por IA más famosas (creada con Midjourney). Engañó a millones. La IA es increíblemente buena creando imágenes fotorrealistas de eventos que nunca ocurrieron.'
            },
            {
                type: 'ai-human',
                question: 'Una foto de dos leyendas del fútbol. ¿Es una imagen real o fue generada por IA?',
                content: {
                    type: 'image',
                    src: 'https://media.ambito.com/p/439378d5634b839a9b9d26f52dda7a05/adjuntos/239/imagenes/042/744/0042744007/1200x675/smart/messi-diego.jpeg',
                    alt: 'Lionel Messi y Diego Maradona abrazándose en el campo de juego.'
                },
                answer: 'humano',
                explanation: '¡Exacto! Esta imagen es 100% real y captura un momento icónico entre dos de los más grandes futbolistas de la historia. Las IAs a veces tienen problemas con manos o fondos, pero aquí todo luce auténtico.'
            },
            {
                type: 'ai-human',
                question: 'Una escena de amistad animal. ¿Es una foto real o fue hecha con IA?',
                content: {
                    type: 'image',
                    src: 'https://us.123rf.com/450wm/perfectlab/perfectlab2304/perfectlab230400170/202429290-pets-cat-and-dog-hugging-together-outdoor-animal-friendship-in-the-family-generative-ai.jpg',
                    alt: 'Un perro y un gato abrazándose tiernamente al aire libre.'
                },
                answer: 'ia',
                explanation: '¡Bien observado! Aunque es una imagen adorable, la perfección de la escena y ciertos detalles en el pelaje o la perspectiva suelen delatar que fue generada por una IA, que crea situaciones "ideales".'
            },
            
            // --- Nivel 3: Arma tu Red Neuronal ---
            {
                type: 'network',
                question: 'Es la 🥇 PRIMERA capa de la red. Recibe los datos crudos (ej: los píxeles de una foto 🖼️, o las palabras de una frase 💬). ¿Cómo se llama?',
                options: ['Capa de Salida', 'Capa Oculta', 'Capa de Entrada'],
                answer: 'Capa de Entrada',
                explanation: '¡Exacto! La <strong>Capa de Entrada (Input Layer)</strong> es como los "sentidos" (ojos, oídos) de la red. Es la puerta por donde entra toda la información del mundo exterior. ¡Fundamental!'
            },
            {
                type: 'network',
                question: 'Es el 🧠 "cerebro" de la red. Aquí es donde ocurren los cálculos complejos y donde la red "aprende" a encontrar patrones. Puede haber muchas de estas capas, actuando como "filtros".',
                options: ['Capa Oculta', 'Capa de Salida', 'Capa de Entrada'],
                answer: 'Capa Oculta',
                explanation: '¡Correcto! Las <strong>Capas Ocultas (Hidden Layers)</strong> hacen el trabajo pesado. Procesan la información, la transforman y extraen características, como si fueran pequeños especialistas trabajando en equipo.'
            },
            {
                type: 'network',
                question: 'Es la 🏆 ÚLTIMA capa de la red. Da la respuesta final y concreta (Ej: "Es un gato 🐱", "Es spam 🗑️", "El precio será $150 💰"). ¡El resultado que esperábamos!',
                options: ['Capa de Entrada', 'Capa Oculta', 'Capa de Salida'],
                answer: 'Capa de Salida',
                explanation: '¡Perfecto! La <strong>Capa de Salida (Output Layer)</strong> es la "boca" de la red. Entrega la conclusión final después de todo el procesamiento. ¡Has armado tu red neuronal completa y entiendes su flujo de información!'
            },

            // --- PREGUNTAS DE EMOJIS (TIPO 'NETWORK') ---
            {
                type: 'network', 
                question: 'Sigue la secuencia de emojis: 🧠 ➡️ 🧠💡 ➡️ 🧠💡📈. ¿Cuál es el siguiente set de emojis?',
                options: ['🧠💡📈🤖', '🧠💡🤖', '🧠💡📈', '💡📈🤖'], 
                answer: '🧠💡📈🤖',
                explanation: '¡Genial! El patrón añade un nuevo concepto de IA cada vez: Cerebro ➡️ Idea ➡️ Crecimiento (Datos) ➡️ IA (Robot). Estabas prediciendo una secuencia conceptual.'
            },
            {
                type: 'network', 
                question: 'Patrón difícil: ☀️🌳 ➡️ 🌙🌱 ➡️ ☀️🌲 (un árbol más grande). ¿Qué sigue en la secuencia lógica?',
                options: ['☀️🌿', '🌙🌲', '🌙🌿', '☀️🌱'], 
                answer: '🌙🌿',
                explanation: '¡Excelente! El patrón es: "Sol hace crecer un árbol" y "Luna hace crecer una planta". La segunda vez que aparece el Sol, el árbol es más grande (🌳 -> 🌲), así que la segunda vez que aparece la Luna, la planta también debe crecer (🌱 -> 🌿).'
            }
        ];

        // --- LÓGICA DEL JUEGO ---
        let currentGameIndex = 0;
        let score = 0; 
        let selectedChoice = null; 
        let timerInterval; // Para guardar la referencia del intervalo del cronómetro
        const TIME_LIMIT_SECONDS = 180; // 3 minutos
        let timeLeft = TIME_LIMIT_SECONDS;
        let gameInProgress = false; // Flag para evitar doble clicks

        // Elementos del DOM
        const gameContainer = document.getElementById('game-container');
        const gameContent = document.getElementById('game-content');
        const feedbackArea = document.getElementById('feedback-area');
        const actionButtonContainer = document.getElementById('action-button-container');
        const restartButton = document.getElementById('restart-button');
        const gameTitle = document.querySelector('#game-container h1');
        const gameSubtitle = document.querySelector('#game-container p');
        const timerDisplay = document.getElementById('timer');
        const feedbackOverlay = document.getElementById('feedback-overlay'); 
        
        // Elementos de la UI de inicio/juego
        const introScreen = document.getElementById('intro-screen');
        const startButton = document.getElementById('start-button');
        const timerContainer = document.getElementById('timer-container');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const controls = document.getElementById('controls');


        // Función para renderizar el juego actual
        function renderGame(index) {
            // Si el tiempo se acabó, no renderizar más preguntas
            if (timeLeft <= 0 || !gameInProgress) {
                return;
            }

            // Limpiar áreas
            gameContent.innerHTML = '';
            feedbackArea.innerHTML = ''; // Limpiar área de feedback (aunque ya no la usamos para la explicación)
            actionButtonContainer.innerHTML = '';
            selectedChoice = null; // Resetear selección

            // Efecto de fade-in
            gameContent.classList.remove('fade-in');
            void gameContent.offsetWidth; // Truco para reiniciar la animación
            gameContent.classList.add('fade-in');

            // --- Pantalla de victoria (si se terminan las preguntas antes del tiempo) ---
            if (index >= gameData.length) {
                stopTimer();
                showFinalScore(false); // Mostrar puntaje final porque se completó el juego
                return;
            }

            const game = gameData[index];

            // Restaurar título original
            gameTitle.innerHTML = '🌟 Desafío <span class="text-blue-300">IA & Datos</span> 🚀';
            gameSubtitle.textContent = 'Pon a prueba tu intuición y conocimiento';

            // El título de la pregunta ahora incluye el número general de la pregunta
            let contentHtml = `<h2 class="text-2xl font-bold text-white mb-6 text-center">(${index + 1}/${gameData.length}) ${game.question}</h2>`;

            // Renderizar según el tipo de juego
            switch (game.type) {
                case 'ai-human':
                    let mediaHtml = '';
                    if (game.content.type === 'image') {
                        mediaHtml = `
                            <div class="mb-6 text-center">
                                <img src="${game.content.src}" alt="${game.content.alt}" class="w-full max-w-md mx-auto rounded-lg shadow-md mb-3 border-4 border-white"
                                 onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A2980/FFFFFF?text=Error+Cargando+Imagen';">
                            </div>
                        `;
                    } else {
                        mediaHtml = `<div class="bg-blue-100 p-5 rounded-xl border border-blue-300 text-blue-900 italic text-center text-lg mb-6 shadow-sm bg-opacity-70 font-bold">"${game.content.text}"</div>`;
                    }
                    
                    contentHtml += `
                        ${mediaHtml}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="ai-button" class="choice-button bg-gradient-to-r from-purple-600 to-indigo-700 text-white p-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-indigo-800 transition-all shadow-lg" data-answer="ia">🤖 Hecho por IA</button>
                            <button id="human-button" class="choice-button bg-gradient-to-r from-green-600 to-teal-700 text-white p-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-teal-800 transition-all shadow-lg" data-answer="humano">👤 Hecho por Humano</button>
                        </div>
                    `;
                    gameContent.innerHTML = contentHtml; 
                    document.getElementById('ai-button').addEventListener('click', () => handleChoice(game, 'ia'));
                    document.getElementById('human-button').addEventListener('click', () => handleChoice(game, 'humano'));
                    break;

                case 'network': 
                    contentHtml += `
                        <div class="flex flex-col gap-4">
                            ${game.options.map((option, idx) => `
                                <button id="option-${idx}" class="choice-button w-full text-left bg-blue-100 text-blue-900 p-4 rounded-xl font-semibold text-lg hover:bg-blue-200 border-2 border-transparent hover:border-blue-500 transition-all shadow-sm bg-opacity-70" data-answer="${option}">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    gameContent.innerHTML = contentHtml; 
                    game.options.forEach((option, idx) => {
                        document.getElementById(`option-${idx}`).addEventListener('click', () => handleChoice(game, option));
                    });
                    break;
            }
        }

        // --- Funciones de Ayuda ---

        // Crear botón de acción principal (Comprobar / Siguiente)
        function createActionButton(text, onClick, isDisabled = false) {
            actionButtonContainer.innerHTML = '';
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition-all text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed';
            button.onclick = onClick;
            button.disabled = isDisabled;
            actionButtonContainer.appendChild(button);
        }

        // Manejar la selección de botones en juegos de elección
        function handleChoice(game, choice) {
            selectedChoice = choice;
            const isCorrect = choice.toLowerCase() === game.answer.toLowerCase();

            // Deshabilitar y colorear botones (feedback inmediato)
            document.querySelectorAll('.choice-button').forEach(button => {
                button.disabled = true;
                const buttonAnswer = button.dataset.answer.toLowerCase();

                // 1. Limpiar todas las clases de hover, gradientes y fondos base
                button.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-indigo-700', 'hover:from-purple-700', 'hover:to-indigo-800', 'from-green-600', 'to-teal-700', 'hover:from-green-700', 'hover:to-teal-800', 'bg-blue-100', 'hover:bg-blue-200', 'bg-opacity-70', 'text-blue-900', 'color-white');
                button.classList.add('text-white'); // Asegurar texto blanco para contraste

                // 2. Aplicar color de feedback
                if (buttonAnswer === choice.toLowerCase()) {
                    // Este es el botón que el usuario clickeó
                    if (isCorrect) {
                        button.classList.add('bg-green-500'); // VERDE
                    } else {
                        button.classList.add('bg-red-500'); // ROJO
                    }
                } else if (!isCorrect && buttonAnswer === game.answer.toLowerCase()) {
                    // Si el usuario se equivocó, este es el botón correcto
                    button.classList.add('bg-green-500', 'opacity-60'); // VERDE (atenuado)
                } else {
                    // Botones no seleccionados y no correctos
                    button.classList.add('bg-gray-400', 'opacity-50'); // GRIS
                }
            });

            checkAnswer(isCorrect, game.explanation);
        }

        // --- FUNCIÓN showFeedback (CON LÓGICA DE REEMPLAZO Y RETRASO) ---
        function showFeedback(isCorrect, explanation) {
            feedbackOverlay.innerHTML = ''; // Limpiar animaciones anteriores
            actionButtonContainer.innerHTML = ''; // <-- Ocultar botón 'Siguiente' inmediatamente
            feedbackArea.innerHTML = ''; // <-- Limpiamos el feedbackArea, no lo usaremos para la explicación.
            
            if (isCorrect) {
                score++; 
                createConfetti(); // <-- LANZAR CONFETI (Inmediato)
            } else {
                showBigCross(); // <-- MOSTRAR CRUZ (Inmediato)
            }
            
            // --- ¡MODIFICACIÓN CLAVE! ---
            // Retrasar la aparición del feedback y el botón 'Siguiente'
            // para que la animación (cruz/confeti) se vea primero.
            setTimeout(() => {

                // 1. RENDERIZAR EL TEXTO DE FEEDBACK (AHORA DENTRO DE gameContent)
                // Esto reemplazará las opciones (que ya están coloreadas) por la explicación.
                let feedbackHtml = '';
                if (isCorrect) {
                    feedbackHtml = `
                        <div class="p-5 rounded-xl fade-in text-lg shadow-md bg-green-100 border border-green-400 text-green-800 bg-opacity-80">
                            <h3 class="font-bold text-xl flex items-center mb-2">
                                <span class="mr-2">🎉</span> ¡Correcto! (+1 punto)
                            </h3>
                            <p class="mt-2"><strong class="text-green-900">Explicación:</strong> ${explanation}</p>
                        </div>
                    `;
                } else {
                    feedbackHtml = `
                        <div class="p-5 rounded-xl fade-in text-lg shadow-md bg-red-100 border border-red-400 text-red-800 bg-opacity-80">
                            <h3 class="font-bold text-xl flex items-center mb-2">
                                <span class="mr-2">❌</span> ¡Incorrecto!
                            </h3>
                            <p class="mt-2"><strong class="text-red-900">Explicación:</strong> ${explanation}</p>
                        </div>
                    `;
                }
                
                // MODIFICACIÓN: Escribir el feedback en gameContent, no en feedbackArea
                gameContent.innerHTML = feedbackHtml;
                
                // 2. MOSTRAR BOTÓN 'SIGUIENTE' (AHORA)
                if (currentGameIndex + 1 < gameData.length && timeLeft > 0) {
                    createActionButton('Siguiente →', () => {
                        currentGameIndex++;
                        renderGame(currentGameIndex);
                    });
                } else if (timeLeft > 0) { // Se acabaron las preguntas y aún hay tiempo
                    stopTimer();
                    showFinalScore(false);
                }
                
                // 3. Ya no se necesita scrollIntoView

            }, 1500); // 1.5 segundos de retraso (coincide con la animación de la cruz)
        }
        
        // Comprobar respuesta de elección
        function checkAnswer(isCorrect, explanation) {
            showFeedback(isCorrect, explanation);
        }

        // --- FUNCIONES DEL CRONÓMETRO ---
        function startTimer() {
            clearInterval(timerInterval); // Limpiar cualquier intervalo anterior
            timeLeft = TIME_LIMIT_SECONDS; // Resetear tiempo
            gameInProgress = true;
            updateTimerDisplay(); // Actualizar display inmediatamente

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    stopTimer();
                    showFinalScore(true); // Mostrar puntaje final al terminar el tiempo
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            gameInProgress = false;
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 30 && timeLeft > 0) { // Menos de 30 segundos, ponerlo en rojo
                timerDisplay.classList.add('text-red-400', 'font-bold');
            } else {
                timerDisplay.classList.remove('text-red-400', 'font-bold');
            }
        }

        // --- FUNCIÓN PARA MOSTRAR LA PANTALLA FINAL ---
        function showFinalScore(timeExpired) {
            stopTimer(); // Asegurarse de que el timer esté detenido
            gameTitle.innerHTML = timeExpired ? '⏰ ¡Tiempo Terminado! ⏰' : '🎉 ¡Juego Terminado! 🎉';
            gameSubtitle.textContent = 'Este es tu puntaje final';
            feedbackOverlay.innerHTML = ''; // Limpiar cualquier animación
            gameContent.innerHTML = ''; // Limpiar contenido del juego
            
            let finalPercentage = 0;
            if (gameData.length > 0) {
                // Calcular porcentaje basado en el TOTAL de preguntas
                finalPercentage = Math.round((score / gameData.length) * 100);
            }
            
            let congratsMessage = "¡Buen intento! Sigue practicando. 🧠";
            if (finalPercentage >= 90) {
                congratsMessage = "¡Excelente! Eres un experto en IA. 🚀";
            } else if (finalPercentage >= 60) {
                congratsMessage = "¡Muy bien! Tienes una gran intuición para los datos. 👍";
            }

            gameContent.innerHTML = `
                <div class="text-center fade-in">
                    <div class="text-7xl font-extrabold text-white mb-4">${score} / ${gameData.length}</div>
                    <div class="text-3xl font-bold text-blue-300 mb-3">${finalPercentage}% de aciertos</div>
                    <p class="text-xl text-white mt-6 font-semibold">
                        ${congratsMessage}
                    </p>
                    <p class="text-blue-100 mt-3 text-lg">
                        ¡Presiona "Reiniciar" para mezclar las preguntas y jugar de nuevo!
                    </p>
                </div>
            `;
            // Limpiar área de feedback y botón de acción
            feedbackArea.innerHTML = '';
            actionButtonContainer.innerHTML = '';
        }

        // --- LÓGICA DE INICIO Y REINICIO ---
        function startGame() {
            // Ocultar intro
            introScreen.style.display = 'none';
            // Mostrar elementos del juego
            gameContent.style.display = 'flex';
            controls.style.display = 'flex';
            timerContainer.style.display = 'flex';
            fullscreenButton.style.display = 'block';

            // Resetear estado
            currentGameIndex = 0;
            score = 0;
            feedbackOverlay.innerHTML = ''; 
            shuffleArray(gameData); 
            startTimer(); // <-- EL CRONÓMETRO EMPIEZA AQUÍ
            renderGame(currentGameIndex);
        }

        function restartGame() {
            stopTimer();
            // Ocultar elementos del juego
            gameContent.style.display = 'none';
            controls.style.display = 'none';
            timerContainer.style.display = 'none';
            fullscreenButton.style.display = 'none';
            feedbackArea.innerHTML = '';
            
            // Mostrar intro
            introScreen.style.display = 'block';

            // Resetear visualmente el timer
            timerDisplay.textContent = '03:00';
            timerDisplay.classList.remove('text-red-400', 'font-bold');
        }
        
        // --- FUNCIONES DE ANIMACIÓN DE FEEDBACK ---
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                const colors = ['#26D0CE', '#1A2980', '#4f46e5', '#a78bfa'];
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = (Math.random() * 110) - 5 + 'vw'; 
                piece.style.top = (Math.random() * -150) + 'px'; 
                piece.style.animation = `confetti-fall ${Math.random() * 2 + 3}s linear ${Math.random() * 1}s forwards`;
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                setTimeout(() => {
                    piece.remove();
                }, 5000); 
                feedbackOverlay.appendChild(piece);
            }
        }

        function showBigCross() {
            const cross = document.createElement('div');
            cross.innerHTML = '❌';
            cross.className = 'feedback-cross';
            feedbackOverlay.appendChild(cross);
            
            setTimeout(() => {
                cross.remove();
            }, 1500); // Coincide con la duración de la animación
        }
        
        // --- FUNCIÓN FULLSCREEN (MODIFICADA CON TRY...CATCH) ---
        async function toggleFullScreen() { 
            const doc = document.documentElement;
            try {
                if (!document.fullscreenElement) {
                    if (doc.requestFullscreen) {
                        await doc.requestFullscreen();
                    } else if (doc.mozRequestFullScreen) { /* Firefox */
                        await doc.mozRequestFullScreen();
                    } else if (doc.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        await doc.webkitRequestFullscreen();
                    } else if (doc.msRequestFullscreen) { /* IE/Edge */
                        await doc.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        await document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) { /* Firefox */
                        await document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) { /* Chrome, Safari & Opera */
                        await document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) { /* IE/Edge */
                        await doc.msExitFullscreen();
                    }
                }
            } catch (err) {
                console.error("Error al intentar cambiar a pantalla completa (probablemente no permitido en este iframe):", err);
            }
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            // Asignar listeners a los botones principales
            startButton.addEventListener('click', startGame);
            fullscreenButton.addEventListener('click', toggleFullScreen);
            restartButton.addEventListener('click', restartGame);
            
            // Añadir un fallback para las imágenes que no carguen
            document.addEventListener('error', (e) => {
                if (e.target.tagName === 'IMG') {
                     e.target.src = 'https://placehold.co/600x400/1A2980/FFFFFF?text=Error+Cargando+Imagen';
                }
            }, true); // Usar captura de eventos para pillar todos los errores de imagen
        });
    </script>
</body>
</html>

